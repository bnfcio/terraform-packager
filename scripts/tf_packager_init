#!/bin/bash
TF_PACKAGER_RUN_SCRIPT="${1}"

TF_PACKAGER_ENVIRONMENT_VARIABLES_BASE_FILE_NAME="environment_variables.conf"

TF_PACKAGER_TEMPORARY_DIRECTORY="${HOME}/.terraform-packager"
TF_PACKAGER_TEMPORARY_BUILD_CONTEXT_DIRECTORY="${TF_PACKAGER_TEMPORARY_DIRECTORY}/build/context"
TF_PACKAGER_ROOT_DIRECTORY="$(dirname "${TF_PACKAGER_RUN_SCRIPT}")"
TF_PACKAGER_SCRIPTS_DIRECTORY_BUILD="${TF_PACKAGER_SCRIPTS_DIRECTORY}/build"
TF_PACKAGER_TEMPLATES_DIRECTORY="${TF_PACKAGER_ROOT_DIRECTORY}/templates"
TF_PACKAGER_TEMPLATES_DIRECTORY_BUILD="${TF_PACKAGER_TEMPLATES_DIRECTORY}/build"
TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME_TEMPLATE="${TF_PACKAGER_TEMPLATES_DIRECTORY}/${TF_PACKAGER_ENVIRONMENT_VARIABLES_BASE_FILE_NAME}"
TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME="${TF_PACKAGER_TEMPORARY_DIRECTORY}/${TF_PACKAGER_ENVIRONMENT_VARIABLES_BASE_FILE_NAME}"

TF_PACKAGER_SOURCE_CODE_PROVIDER_FILE="${TF_SOURCE_CODE_DIRECTORY}/provider.tf"
TF_PACKAGER_SOURCE_CODE_TFVARS_FILE="${TF_SOURCE_CODE_DIRECTORY}/terraform.tfvars"
TF_PACKAGER_SOURCE_CODE_STACK_CONFIG_FILE="${TF_SOURCE_CODE_DIRECTORY}/stack.conf"

export TF_PACKAGER_TEMPORARY_DIRECTORY
export TF_PACKAGER_RUN_SCRIPT
export TF_PACKAGER_ROOT_DIRECTORY
export TF_PACKAGER_SCRIPTS_DIRECTORY_BUILD
export TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME
export TF_PACKAGER_TEMPLATES_DIRECTORY
export TF_PACKAGER_TEMPLATES_DIRECTORY_BUILD
export TF_SOURCE_CODE_DIRECTORY
export TF_PACKAGER_SOURCE_CODE_PROVIDER_FILE
export TF_PACKAGER_SOURCE_CODE_TFVARS_FILE
export TF_PACKAGER_SOURCE_CODE_STACK_CONFIG_FILE
export TF_PACKAGER_TEMPORARY_BUILD_CONTEXT_DIRECTORY

mkdir -p "${TF_PACKAGER_TEMPORARY_DIRECTORY}"

source "${TF_PACKAGER_SOURCE_CODE_STACK_CONFIG_FILE}"

export STACK_NAME
export STACK_VERSION
export STACK_INSTANCE_NAME=${STACK_INSTANCE_NAME-default}
export TERRAFORM_VERSION

envsubst < "${TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME_TEMPLATE}" > "${TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME}"
